sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator","meg/workorder/utils/CallUtil","sap/m/MessageBox"],function(e,t,a,r,o,i,s){"use strict";return e.extend("meg.workorder.controller.ObjectPage",{onInit:async function(){this.localModel=this.getOwnerComponent().getModel("localModel");var e=this.getOwnerComponent().getRouter();e.getRoute("RouteObjectPage").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:async function(e){this.WorkOrderId=e.getParameter("arguments").id;this.serviceUrl=this.getOwnerComponent().getModel("WorkOrderModel").sServiceUrl;var t="?$filter=WorkOrder eq '"+this.WorkOrderId+"'";var a="&$expand=OrdOperationNav,EquipBOMItemNav,AddPartItemNav";var r=await i.callGetData(this.serviceUrl+"/ZUSPPMEG01_WORK_ORDER_HEADERSet"+t+a+"&$format=json");var o,s,l,n;if(r&&r.d.results.length>0){r=r.d.results[0];this.localModel.setProperty("/workOrderHeader",r);if(r&&r.OrdOperationNav){o=r.OrdOperationNav.results}if(r&&r.EquipBOMItemNav){this.getEquipBOMData(r.EquipBOMItemNav.results,o)}if(r&&r.AddPartItemNav){this.getAddPartsData(r.AddPartItemNav.results)}}this.localModel.setProperty("/orderOperations",o)},getAddPartsData:async function(e){var t=this.getView().byId("addPartItemsID");t.setShowOverlay(true);var a=this.serviceUrl;var r=this.localModel.getData().workOrderHeader.Plant;let o=0;for(o=0;o<e.length;o++){var s=e[o].Part;var l=await i.callGetData(a+"/ZUSPPMEG01_MATERIAL_STORAGE_LOCATIONSet?$filter=Part eq '"+s+"' and Plant eq '"+r+"'&$format=json");if(l&&l.d&&l.d.results){var n="";if(e[o].StorageLocation!=""){n=e[o].StorageLocation}e[o].StorageLocation=l.d.results;if(l.d.results.length>1){e[o].isEnabled=true;e[o].isSelected=false}else{e[o].isEnabled=false;e[o].isSelected=true}if(n!=""){e[o].StorageLocation.StorageLocation=n}}}this.localModel.setProperty("/AddPartsItems",e);t.setShowOverlay(false)},getEquipBOMData:async function(e,t){var a=this.getView().byId("equiBOMID");a.setShowOverlay(true);a.removeSelections(true);var r=this.serviceUrl;var o=this.localModel.getData().workOrderHeader.Plant;let s=0;for(s=0;s<e.length;s++){if(t.length==1){e[s].Operation=t[0].OperationNum;e[s].OperationDesc=t[0].OperationDesc}var l=e[s].Part;var n=await i.callGetData(r+"/ZUSPPMEG01_MATERIAL_STORAGE_LOCATIONSet?$filter=Part eq '"+l+"' and Plant eq '"+o+"'&$format=json");if(n&&n.d&&n.d.results){var d="";if(e[s].StorageLocation!=""){d=e[s].StorageLocation}e[s].StorageLocation=n.d.results;if(n.d.results.length>1){e[s].isEnabled=true;e[s].isSelected=false}else{e[s].isEnabled=false;e[s].isSelected=true}if(d!=""){e[s].StorageLocation.StorageLocation=d}}}this.localModel.setProperty("/equipBOMItems",e);a.setShowOverlay(false)},onOperationValueHelp:async function(e){var t=e.getSource().oPropagatedProperties.oBindingContexts.localModel.sPath;this.OPValueHelpIndex=t.split("/")[2];if(!this._oDialogOperation){this._oDialogOperation=sap.ui.xmlfragment("meg.workorder.fragments.OrderOperation",this);this.getView().addDependent(this._oDialogOperation);this.VHID="Operation";var a=await i.callGetData(this.serviceUrl+"/ZUSPPMEG01_OPERATION_F4Set?$format=json&$filter=WorkOrder eq '"+this.WorkOrderId+"'");a=a.d.results;this.localModel.setProperty("/ZUSPPMEG01_OPERATION_F4Set",a);this._oDialogOperation.open()}this.VHID="Operation";this._oDialogOperation.open()},onAddOperationValueHelp:async function(e){var t=e.getSource().oPropagatedProperties.oBindingContexts.localModel.sPath;this.AddOPValueHelpIndex=t.split("/")[2];if(!this._oDialogAddOperation){this._oDialogAddOperation=sap.ui.xmlfragment("meg.workorder.fragments.OrderOperationAdd",this);this.getView().addDependent(this._oDialogAddOperation);this.VHID="AddOperation";var a=await i.callGetData(this.serviceUrl+"/ZUSPPMEG01_OPERATION_F4Set?$format=json&$filter=WorkOrder eq '"+this.WorkOrderId+"'");a=a.d.results;this.localModel.setProperty("/ZUSPPMEG01_ADD_OPERATION_F4Set",a);this._oDialogAddOperation.open()}this.VHID="AddOperation";this._oDialogAddOperation.open()},onAddPartValueHelp:async function(e){var t=e.getSource().oPropagatedProperties.oBindingContexts.localModel.sPath;this.valueHelpIndex=t.split("/")[2];if(!this._oDialogAddPart){this._oDialogAddPart=sap.ui.xmlfragment("meg.workorder.fragments.AdditionalPart",this);this.getView().addDependent(this._oDialogAddPart);this.VHID="WorkOrder";var a=await i.callGetData(this.serviceUrl+"/ZUSPPMEG01_PART_F4Set?$format=json");a=a.d.results;this.localModel.setProperty("/ZUSPPMEG01_PART_F4Set",a);this._oDialogAddPart.open()}this._oDialogAddPart.open()},onRowAddParts:function(){var e=this.localModel.getData();var t=this.localModel.getData().orderOperations;var a="",r="";if(t.length==1){a=t[0].OperationNum;r=t[0].OperationDesc}var o={Part:"",PartDesc:"",DesiredQuan:"",Operation:a,OperationDesc:r,StorageLocation:"",isEnabled:false,isSelected:true};e.AddPartsItems.push(o);this.localModel.refresh()},onTableRowDelete:function(e){var t=e.getSource().oPropagatedProperties.oBindingContexts.localModel.sPath;var a=t.split("/")[2];var r=this.localModel.getData().AddPartsItems;r.splice(a,1);this.localModel.refresh()},handlePartConfirm:async function(e){var t=e.getParameter("selectedItem").getTitle();var a=e.getParameter("selectedItem").getDescription();var r=this.localModel.getData().workOrderHeader.Plant;var o=this.localModel.getData().orderOperations;var s=this.localModel.getData().AddPartsItems;var l=await i.callGetData(this.serviceUrl+"/ZUSPPMEG01_MATERIAL_STORAGE_LOCATIONSet?$filter=Part eq '"+t+"' and Plant eq '"+r+"'&$format=json");s[this.valueHelpIndex].Part=t;s[this.valueHelpIndex].PartDesc=a;s[this.valueHelpIndex].isEnabled=a;if(o&&o.length==1){s[this.valueHelpIndex].Operation=o[0].OperationNum;s[this.valueHelpIndex].OperationDesc=o[0].OperationDesc}if(l&&l.d&&l.d.results){s[this.valueHelpIndex].StorageLocation=l.d.results;if(l.d.results.length>1){s[this.valueHelpIndex].isEnabled=true;s[this.valueHelpIndex].isSelected=false}else{s[this.valueHelpIndex].isEnabled=false;s[this.valueHelpIndex].isSelected=true}}this.localModel.refresh()},onSelectOperation:function(e){var t=e.getParameter("selectedItem").getTitle();var a=e.getParameter("selectedItem").getDescription();var r=this.localModel.getData().equipBOMItems[this.OPValueHelpIndex];r.Operation=t;r.OperationDesc=a;this.localModel.refresh()},onAddSelectOperation:function(e){var t=e.getParameter("selectedItem").getTitle();var a=e.getParameter("selectedItem").getDescription();var r=this.localModel.getData().AddPartsItems[this.AddOPValueHelpIndex];r.Operation=t;r.OperationDesc=a;this.localModel.refresh()},onValueHelpSearch:function(e){var t=e.getParameter("value");var a=new r("Part",o.Contains,t);var i=e.getParameter("itemsBinding");i.filter([a])},passWOReservation:async function(e){var t=this.byId("equiBOMID");var a=t.getSelectedContextPaths();var r=this.localModel.getData();this.localModel.setProperty("/selectedEquiBOM",[]);var o=this.serviceUrl+"/ZUSPPMEG01_WORK_ORDER_HEADERSet";if(a&&a.length>0){a.forEach(function(e){var t=e.split("/")[2];var a=r.equipBOMItems[t];if(r.equipBOMItems[t].DesiredQuan==""){}if(r.equipBOMItems[t].Operation==""){}a={WorkOrder:a.WorkOrder,Part:a.Part,PartDesc:a.PartDesc,BOMQuan:a.BOMQuan,DesiredQuan:a.DesiredQuan,Operation:a.Operation,Select:a.Select,StorageLocation:a.StorageLocation.StorageLocation};r.selectedEquiBOM.push(a)})}if(r.orderOperations){r.orderOperations.forEach(function(e){delete e.__metadata;delete e.Status})}if(r.AddPartsItems){r.AddPartsItems.forEach(function(e){e.WorkOrder=r.workOrderHeader.WorkOrder;delete e.isEnabled;delete e.isSelected;if(e.StorageLocation){e.StorageLocation=e.StorageLocation.StorageLocation}})}var l=true;if(r.selectedEquiBOM){r.selectedEquiBOM.forEach(function(e){if(e.DesiredQuan==""||e.Operation==""||e.StorageLocation==""||e.StorageLocation==undefined){l=false}})}if(r.AddPartsItems){r.AddPartsItems.forEach(function(e){if(e.DesiredQuan==""||e.Operation==""||e.StorageLocation==""||e.StorageLocation==undefined){l=false}})}if(!l){s.warning("PLEASE ENTER THE DESIRED QUANTITY, OPERATION AND STORAGE LOCATION FOR THE SELECTED ITEMS"),{styleClass:"alignCenter"};return}var n={WorkOrder:r.workOrderHeader.WorkOrder,Plant:r.workOrderHeader.Plant,OrderType:r.workOrderHeader.OrderType,Description:r.workOrderHeader.Description,PlannerGroup:r.workOrderHeader.PlannerGroup,WorkCenter:r.workOrderHeader.WorkCenter,FunctLocation:r.workOrderHeader.FunctLocation,Equipment:r.workOrderHeader.Equipment,OrdOperationNav:r.orderOperations,EquipBOMItemNav:r.selectedEquiBOM,AddPartItemNav:r.AddPartsItems,LogNav:[{}]};var d=await i.callPostData(o,n);console.log(d);this.localModel.refresh()},onBomItemSel:function(e){var t=e.getParameter("selected");var a=e.getParameter("listItem").getBindingContextPath();var r=a.split("/")[2];var o=this.localModel.getData().equipBOMItems[r];if(o.DesiredQuan==""){o.DesiredQuan=o.BOMQuan}this.localModel.refresh()},onPartEnter:async function(e){var t=e.getSource().oPropagatedProperties.oBindingContexts.localModel.sPath;this.partItemIndex=t.split("/")[2];var a=e.getParameter("value");var r="Part eq '"+a+"'";var o=await i.callGetData(this.serviceUrl+"/ZUSPPMEG01_PART_F4Set?&$filter="+r+"&$format=json");o=o.d.results;var s=o[0].Part;var l=o[0].Description;var n=this.localModel.getData().AddPartsItems;n[this.partItemIndex].Part=s;n[this.partItemIndex].PartDesc=l;this.localModel.refresh()},onDesChange:function(e){var t=e.getSource();var a=e.getParameter("value");var r=/^-?\d*\.?\d*$/;if(!r.test(a)){var o=a.slice(0,-1);t.setValue(o)}},onOpChange:function(e){var t=e.getSource();var a=e.getParameter("value");if(a.length>4){var r=a.slice(0,4)}t.setValue(r)}})});
//# sourceMappingURL=ObjectPage.controller.js.map